<!doctype html>
<html lang="ko" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Open Job Crawler</title>
  <meta name="description" content="인턴 · 주니어 개발자 포지션 자동 수집 피드" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%230ea5e9'/%3E%3Cpath d='M20 55c18 4 21-18 40-14 10 2 16 10 20 19' stroke='white' stroke-width='10' fill='none' stroke-linecap='round'/%3E%3C/svg%3E" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: "0 1px 1px rgba(0,0,0,.04), 0 10px 20px rgba(0,0,0,.04)",
          },
        }
      }
    }
  </script>
  <style>
    /* line clamp (no plugin) */
    .clamp-2{ display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .clamp-3{ display:-webkit-box; -webkit-line-clamp:3; line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    /* card accent via CSS variable */
    .card-accent::before{ content:""; position:absolute; inset:0 0 auto 0; height:3px; border-radius:9999px; background:linear-gradient(90deg, hsl(var(--h,200) 90% 62%), hsl(calc(var(--h,200)+40) 85% 58%)); }
    /* glass header */
    .glass{ backdrop-filter: saturate(140%) blur(8px); }
  </style>
</head>
<body class="h-full bg-white text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100">
  <!-- Header -->
  <header class="sticky top-0 z-30 glass bg-white/75 dark:bg-neutral-900/60 border-b border-neutral-200/60 dark:border-neutral-800">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
      <div class="size-8 rounded-xl bg-gradient-to-tr from-sky-400 to-cyan-300 shadow ring-1 ring-black/5"></div>
      <div class="mr-auto">
        <h1 class="text-base sm:text-lg font-semibold leading-tight">Open Job Crawler</h1>
        <p class="text-xs text-neutral-500 dark:text-neutral-400">미국 인턴·주니어 포지션 자동 수집 피드</p>
      </div>
      <button id="themeToggle" class="text-sm px-3 py-1.5 rounded-lg border border-neutral-200 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-900">🌙/☀️</button>
      <a id="ghLink" href="#" target="_blank" class="text-sm px-3 py-1.5 rounded-lg bg-neutral-900 text-white dark:bg-white dark:text-neutral-900">GitHub</a>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-4 pb-24 pt-6 space-y-6">
    <!-- Controls -->
    <section class="flex flex-col sm:flex-row gap-3 sm:items-center">
      <div class="relative flex-1">
        <input id="q" type="search" placeholder="검색: 회사, 포지션, 지역, 요약…" class="w-full rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white/70 dark:bg-neutral-900/70 px-4 py-3 pl-10 shadow-soft focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <svg class="absolute left-3 top-3.5 size-5 opacity-60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </div>
      <select id="sort" class="rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white/70 dark:bg-neutral-900/70 px-4 py-3">
        <option value="recent">정렬: 최신</option>
        <option value="company">정렬: 회사 A→Z</option>
        <option value="position">정렬: 포지션 A→Z</option>
      </select>
      <button id="compact" class="rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white/70 dark:bg-neutral-900/70 px-4 py-3">Compact</button>
    </section>

    <!-- Stats -->
    <section class="flex items-center justify-between text-sm text-neutral-500 dark:text-neutral-400">
      <div><span id="count">0</span>개 결과</div>
      <div>업데이트됨 <span id="updated">—</span></div>
    </section>

    <!-- List -->
    <section id="list" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></section>

    <!-- Empty -->
    <template id="emptyTpl">
      <div class="rounded-2xl border border-neutral-200 dark:border-neutral-800 p-10 text-center">
        <div class="mx-auto mb-2 size-10 rounded-full bg-neutral-100 dark:bg-neutral-800 flex items-center justify-center">🗂️</div>
        <p class="text-neutral-600 dark:text-neutral-400">조건에 맞는 공고가 없어요.</p>
      </div>
    </template>

    <!-- Skeleton card template -->
    <template id="skeletonTpl">
      <div class="relative rounded-2xl border border-neutral-200 dark:border-neutral-800 p-4 overflow-hidden">
        <div class="card-accent"></div>
        <div class="animate-pulse space-y-3">
          <div class="h-5 w-2/3 bg-neutral-200 dark:bg-neutral-800 rounded"></div>
          <div class="h-3 w-1/2 bg-neutral-200 dark:bg-neutral-800 rounded"></div>
          <div class="h-20 w-full bg-neutral-200 dark:bg-neutral-800 rounded"></div>
          <div class="h-7 w-32 bg-neutral-200 dark:bg-neutral-800 rounded"></div>
        </div>
      </div>
    </template>

    <!-- Job card template -->
    <template id="cardTpl">
      <div class="relative rounded-2xl border border-neutral-200 dark:border-neutral-800 p-4 shadow-soft hover:shadow transition overflow-hidden">
        <div class="card-accent"></div>
        <div class="flex items-start justify-between gap-2">
          <h3 class="font-semibold leading-snug text-neutral-900 dark:text-neutral-100"></h3>
          <span class="text-xs px-2 py-1 rounded-full bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300"></span>
        </div>
        <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400 company"></p>
        <p class="mt-3 text-sm clamp-3 text-neutral-700 dark:text-neutral-300 desc"></p>
        <div class="mt-3 flex flex-wrap gap-2 tags"></div>
        <a class="mt-4 inline-flex items-center gap-1 text-sm text-sky-700 dark:text-sky-400 underline underline-offset-2" target="_blank" rel="noopener">원문 보기<svg class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 17L17 7"/><path d="M7 7h10v10"/></svg></a>
      </div>
    </template>
  </main>

  <footer class="border-t border-neutral-200 dark:border-neutral-800 py-10 text-center text-xs text-neutral-500 dark:text-neutral-400">Made with ♥ by Lumi — Open Job Crawler</footer>

  <script>
    // --- theme ---
    const root = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const setTheme = (mode) => {
      if (mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
      localStorage.setItem('theme', mode);
      themeToggle.textContent = mode === 'dark' ? '☀️ 밝게' : '🌙 어둡게';
    };
    (function initTheme(){
      const saved = localStorage.getItem('theme');
      setTheme(saved || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
    })();
    themeToggle.addEventListener('click', () => setTheme(root.classList.contains('dark') ? 'light' : 'dark'));

    // --- utils ---
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const escapeHtml = (s='') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    const hFromSlug = (slug='') => {
      // derive H from slug hash for accent color
      let n = 0; for (let i=0;i<Math.min(slug.length, 6);i++){ n = (n*17 + slug.charCodeAt(i)) % 360 }
      return n;
    };
    const inferTags = (j) => {
      const s = (j.summary_ko||'') + ' ' + (j.location||'');
      const tags = [];
      if (/remote|리모트|원격/i.test(s)) tags.push('원격');
      if (/hybrid|하이브리드/i.test(s)) tags.push('하이브리드');
      if (/visa|비자|sponsorship|H-1B|OPT|CPT/i.test(s)) tags.push('비자');
      if (/intern|인턴/i.test(s)) tags.push('인턴');
      return tags;
    };

    // --- elements ---
    const list = document.getElementById('list');
    const q = document.getElementById('q');
    const sortSel = document.getElementById('sort');
    const compactBtn = document.getElementById('compact');
    const countEl = document.getElementById('count');
    const updatedEl = document.getElementById('updated');

    let JOBS = [];
    let compact = false;

    function setCompact(on){
      compact = on; localStorage.setItem('compact', on? '1':'');
      list.className = on ? 'grid gap-3 sm:grid-cols-2 lg:grid-cols-4' : 'grid gap-4 sm:grid-cols-2 lg:grid-cols-3';
      compactBtn.classList.toggle('bg-neutral-100', on);
      compactBtn.classList.toggle('dark:bg-neutral-800', on);
    }

    // skeletons while loading
    function showSkeleton(n=6){
      list.innerHTML = '';
      const tpl = document.getElementById('skeletonTpl');
      for(let i=0;i<n;i++) list.appendChild(tpl.content.cloneNode(true));
    }

    function render(items){
      countEl.textContent = items.length;
      if (!items.length){ list.innerHTML = ''; list.appendChild(document.getElementById('emptyTpl').content.cloneNode(true)); return; }
      const tpl = document.getElementById('cardTpl');
      list.innerHTML = '';
      for (const j of items){
        const node = tpl.content.cloneNode(true);
        const card = node.querySelector('div');
        card.style.setProperty('--h', hFromSlug(j.slug));
        card.dataset.hay = `${j.company} ${j.position} ${j.location} ${j.summary_ko}`.toLowerCase();
        $('h3', node).textContent = j.position || '-';
        $('span', node).textContent = j.location || '미기재';
        $('.company', node).textContent = j.company || '';
        $('.desc', node).textContent = j.summary_ko || '';
        const link = $('a', node);
        link.href = j.url; link.rel = 'noopener';
        // tags
        const tg = inferTags(j);
        const wrap = $('.tags', node);
        tg.forEach(t => {
          const b = document.createElement('span');
          b.className = 'text-[11px] px-2 py-1 rounded-full bg-sky-100 text-sky-700 dark:bg-sky-900/40 dark:text-sky-300';
          b.textContent = t; wrap.appendChild(b);
        });
        list.appendChild(node);
      }
    }

    function applyFilters(){
      const s = q.value.trim().toLowerCase();
      let items = JOBS;
      if (s){ items = items.filter(j => `${j.company} ${j.position} ${j.location} ${j.summary_ko}`.toLowerCase().includes(s)); }
      const how = sortSel.value;
      if (how === 'company') items = items.slice().sort((a,b)=> (a.company||'').localeCompare(b.company||''));
      else if (how === 'position') items = items.slice().sort((a,b)=> (a.position||'').localeCompare(b.position||''));
      else items = items.slice().sort((a,b)=> (b.slug||'').localeCompare(a.slug||'')); // pseudo-recent
      render(items);
    }

    // debounce
    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

    async function boot(){
      // restore compact
      setCompact(!!localStorage.getItem('compact'));
      showSkeleton(6);
      try {
        const res = await fetch('data/jobs.json?ts=' + Date.now());
        const data = await res.json();
        JOBS = Array.isArray(data) ? data : [];
        updatedEl.textContent = new Date().toLocaleString();
        applyFilters();
      } catch (e){
        list.innerHTML = `<div class='rounded-2xl border border-red-200 dark:border-red-900 p-6 text-sm text-red-700 dark:text-red-300'>데이터를 불러오지 못했어요. 잠시 후 다시 시도해주세요.</div>`
      }
    }

    q.addEventListener('input', debounce(applyFilters, 120));
    sortSel.addEventListener('change', applyFilters);
    compactBtn.addEventListener('click', ()=> setCompact(!compact));

    boot();
  </script>
</body>
</html>
